<div class="client-files-container">
    <div class="page-header">
        <div class="header-content">
            <h1>üìÅ Archivos de Clientes</h1>
            <p>Gestiona los pagos de todos tus clientes</p>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="filters-section">
        <div class="search-box">
            <input type="text" placeholder="üîç Buscar cliente por nombre o email..." [(ngModel)]="searchTerm"
                (input)="onSearchChange()" class="search-input">
        </div>
        <div class="sort-controls">
            <label>Categor√≠a:</label>
            <select [(ngModel)]="selectedCategoria" (change)="onCategoriaChange()" class="sort-select">
                <option value="todas">Todas las categor√≠as</option>
                <option *ngFor="let cat of categorias" [value]="cat">{{ cat }}</option>
            </select>
        </div>
        <div class="sort-controls">
            <label>Ordenar por:</label>
            <select [(ngModel)]="sortBy" (change)="onSortChange()" class="sort-select">
                <option value="nombre">Nombre (A-Z)</option>
                <option value="pagos">M√°s Pagos</option>
                <option value="monto">Mayor Monto</option>
            </select>
        </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="loading-container">
        <div class="spinner"></div>
        <p>Cargando archivos de clientes...</p>
    </div>

    <!-- Client Files Grid -->
    <div *ngIf="!loading && filteredFiles.length > 0" class="client-files-grid">
        <div *ngFor="let file of filteredFiles" class="client-file-card" (click)="viewClientDetail(file)">
            <!-- Client Header -->
            <div class="file-header">
                <div class="client-avatar">
                    {{ (file.cliente.displayName || file.cliente.email).charAt(0).toUpperCase() }}
                </div>
                <div class="client-info">
                    <h3>{{ file.cliente.displayName || file.cliente.email }}</h3>
                    <p class="client-email" *ngIf="file.cliente.displayName">{{ file.cliente.email }}</p>
                    <p class="client-status">
                        <span [class]="'status-badge ' + (file.cliente.isActive ? 'active' : 'inactive')">
                            {{ file.cliente.isActive ? '‚úì Activo' : '‚úó Inactivo' }}
                        </span>
                    </p>
                </div>
            </div>

            <!-- Stats Summary -->
            <div class="file-stats">
                <div class="stat-item">
                    <span class="stat-label">Total Pagos</span>
                    <span class="stat-value">{{ file.totalPagos }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Monto Total</span>
                    <span class="stat-value">S/ {{ file.totalMonto | number:'1.2-2' }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Pendientes</span>
                    <span class="stat-value pending">{{ file.pagosPendientes }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Pagados</span>
                    <span class="stat-value completed">{{ file.pagosPagados }}</span>
                </div>
            </div>

            <!-- Last Payment -->
            <div class="last-payment" *ngIf="file.ultimoPago">
                <p class="last-payment-label">√öltimo pago:</p>
                <p class="last-payment-info">
                    <span>{{ file.ultimoPago.concepto }}</span>
                    <span class="last-payment-amount">S/ {{ file.ultimoPago.monto | number:'1.2-2' }}</span>
                </p>
            </div>

            <!-- Quick Actions -->
            <div class="file-actions" (click)="$event.stopPropagation()">
                <button class="btn-action btn-add" (click)="createPagoForClient(file)" title="Agregar pago">
                    ‚ûï Nuevo Pago
                </button>
                <button class="btn-action btn-view" (click)="viewClientDetail(file)" title="Ver detalles">
                    üëÅÔ∏è Ver Todo
                </button>
            </div>
        </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loading && filteredFiles.length === 0" class="empty-state">
        <div class="empty-icon">üìÅ</div>
        <h3>No se encontraron clientes</h3>
        <p *ngIf="searchTerm || selectedCategoria !== 'todas'">Intenta con otro t√©rmino de b√∫squeda o categor√≠a</p>
        <p *ngIf="!searchTerm && selectedCategoria === 'todas'">
            No hay clientes registrados en el sistema.<br>
            Los clientes deben registrarse con rol 'cliente' para aparecer aqu√≠.
        </p>
        <button *ngIf="!searchTerm && selectedCategoria === 'todas'" class="btn-action btn-add"
            style="margin-top: 20px;" onclick="console.log('Verificar usuarios en Firebase')">
            üîç Ver Logs en Consola
        </button>
    </div>

    <!-- Client Detail Modal -->
    <div *ngIf="selectedClient" class="modal-overlay" (click)="closeClientDetail()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <div>
                    <h2>üìã Archivo de {{ selectedClient.cliente.displayName || selectedClient.cliente.email }}</h2>
                    <p class="modal-subtitle" *ngIf="selectedClient.cliente.displayName">{{ selectedClient.cliente.email
                        }}</p>
                    <p class="modal-subtitle" *ngIf="!selectedClient.cliente.displayName">Todos los pagos del cliente
                    </p>
                </div>
                <button class="btn-close" (click)="closeClientDetail()">‚úï</button>
            </div>

            <div class="modal-body">
                <!-- Client Summary -->
                <div class="client-summary">
                    <div class="summary-card">
                        <span class="summary-label">Total Pagos</span>
                        <span class="summary-value">{{ selectedClient.totalPagos }}</span>
                    </div>
                    <div class="summary-card">
                        <span class="summary-label">Monto Total</span>
                        <span class="summary-value">S/ {{ selectedClient.totalMonto | number:'1.2-2' }}</span>
                    </div>
                    <div class="summary-card">
                        <span class="summary-label">Pendientes</span>
                        <span class="summary-value">{{ selectedClient.pagosPendientes }}</span>
                    </div>
                    <div class="summary-card">
                        <span class="summary-label">Pagados</span>
                        <span class="summary-value">{{ selectedClient.pagosPagados }}</span>
                    </div>
                </div>

                <!-- Add New Payment Button -->
                <div class="modal-actions">
                    <button class="btn-add-pago" (click)="createPagoForClient(selectedClient)">
                        ‚ûï Agregar Nuevo Pago para este Cliente
                    </button>
                </div>

                <!-- Payments List -->
                <div class="pagos-list">
                    <h3>Historial de Pagos</h3>

                    <div *ngIf="selectedClient.pagos.length === 0" class="no-pagos">
                        <p>Este cliente no tiene pagos registrados</p>
                        <button class="btn-create-first" (click)="createPagoForClient(selectedClient)">
                            Crear Primer Pago
                        </button>
                    </div>

                    <div *ngFor="let pago of selectedClient.pagos" class="pago-item">
                        <div class="pago-header-row">
                            <div class="pago-main-info">
                                <h4>{{ pago.concepto }}</h4>
                                <span [class]="'estado-badge ' + getEstadoClass(pago.estado)">
                                    {{ getEstadoIcon(pago.estado) }} {{ pago.estado }}
                                </span>
                            </div>
                            <div class="pago-amount">
                                S/ {{ pago.monto | number:'1.2-2' }}
                            </div>
                        </div>

                        <div class="pago-details-row">
                            <div class="pago-detail">
                                <span class="detail-label">Categor√≠a:</span>
                                <span class="detail-value">{{ pago.categoria }}</span>
                            </div>
                            <div class="pago-detail">
                                <span class="detail-label">Fecha:</span>
                                <span class="detail-value">
                                    {{ pago.fecha?.toDate ? pago.fecha.toDate() : pago.fecha | date:'dd/MM/yyyy' }}
                                </span>
                            </div>
                            <div class="pago-detail" *ngIf="pago.metodoPago">
                                <span class="detail-label">M√©todo:</span>
                                <span class="detail-value">
                                    <span *ngIf="pago.metodoPago === 'yape'">üì± Yape</span>
                                    <span *ngIf="pago.metodoPago === 'tarjeta'">üí≥ Tarjeta</span>
                                    <span *ngIf="pago.metodoPago === 'efectivo'">üíµ Efectivo</span>
                                    <span *ngIf="pago.metodoPago === 'transferencia'">üè¶ Transferencia</span>
                                    <span *ngIf="pago.metodoPago === 'otro'">üìù Otro</span>
                                </span>
                            </div>
                        </div>

                        <div class="pago-description" *ngIf="pago.descripcion">
                            <span class="detail-label">Descripci√≥n:</span>
                            <p>{{ pago.descripcion }}</p>
                        </div>

                        <div class="pago-actions-row">
                            <button class="btn-edit-pago" (click)="editPago(pago.id!)">
                                ‚úèÔ∏è Editar
                            </button>
                            <button class="btn-delete-pago" (click)="deletePago(pago)">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>